# SPDX-License-Identifier: GPL-3.0-or-later
#
# Copyright (C) 2018-2019 Nathan Chancellor
#
# Utility and terminal setup functions for Termux on Android


# Download files and set up environment
# Requires
# $ pkg install zsh && chsh -s zsh && echo "extra-keys = [['ESC','/','-','HOME','UP','END','PGUP'],['TAB','CTRL','ALT','LEFT','DOWN','RIGHT','PGDN']]" > ~/.termux/termux.properties
# GPG and SSH keys to be available in the Downloads folder
function bootstrap() {(
    source <(curl -LSs https://github.com/nathanchance/scripts/raw/master/common) &>/dev/null || return 1
    source <(curl -LSs https://github.com/nathanchance/scripts/raw/master/funcs/pure) &>/dev/null || return 1

    pkg upgrade
    termux-setup-storage
    pkg install bison \
                clang \
                flex \
                git \
                gnupg \
                hub \
                jq \
                lld \
                llvm \
                make \
                mosh \
                mutt \
                openssl \
                ripgrep \
                tmux

    # Install ssh and gpg keys
    DOWNLOADS=${HOME}/storage/downloads
    mkdir -p "${HOME}"/.ssh
    cp -v "${DOWNLOADS}"/id_ed25519 "${HOME}"/.ssh
    chmod 600 "${HOME}"/.ssh/id_ed25519
    gpg --pinentry-mode loopback --import "${DOWNLOADS}"/{public*,private*}.asc || die "Error installing gpg keys!"
    gpg --import-ownertrust "${DOWNLOADS}"/ownertrust*.asc || die "Error installing gpg ownertrust!"
    {
        echo "default-cache-ttl 604800"
        echo "max-cache-ttl 2419200"
    } > "${HOME}"/.gnupg/gpg-agent.conf
    gpg-connect-agent reloadagent /bye

    # Configure git
    git config --global commit.gpgsign true
    git config --global core.editor vim
    git config --global sendemail.smtpEncryption tls
    git config --global sendemail.smtpServer smtp.gmail.com
    git config --global sendemail.smtpUser natechancellor@gmail.com
    git config --global sendemail.smtpServerPort 587
    git config --global user.name "Nathan Chancellor"
    git config --global user.email "natechancellor@gmail.com"
    git config --global user.signingkey 2437CB76E544CB6AB3D9DFD399739260CB6CB716

    # Downloads scripts
    git clone git@github.com:nathanchance/scripts

    # Download and install dotfiles
    DOTFILES=${HOME}/dotfiles
    git clone git@github.com:nathanchance/dotfiles
    (
        zsh "${DOTFILES}"/common/global_gitignore.sh
        zsh "${DOTFILES}"/common/vim/vim_setup.sh
        zsh "${DOTFILES}"/server/zshrc.sh
        cp -v "${DOTFILES}"/pixelbook/.tmux.conf "${HOME}"
        gpg --pinentry-mode loopback --output "${HOME}"/.muttrc --decrypt "${DOTFILES}"/common/muttrc.gpg
    ) || die "Error installing dotfiles"

    # Install Pure prompt
    pure_prompt
)}


# Android aliases
function android_aliases() {
    alias git='hub'
    alias mshsvr='mosh nathan@${HETZNER_IP}'
    alias upd='pkg upgrade'
}


# Setup Android prompt
function android_prompt() {
    autoload -U promptinit && promptinit
    prompt pure
}


# Android environment setup
function android_setup() {
    android_prompt
}


# vi: filetype=zsh

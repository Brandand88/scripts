#!/usr/bin/env bash
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Copyright (C) 2018 Nathan Chancellor
#
# Utility and terminal setup functions for my Pixelbook


# Downloads folder
alias dwnld='cd ${HOME}/Downloads'
# Files folder
alias fls='cd ${HOME}/Downloads/Files'


# Make hostname 'flashbook'
sudo hostname flashbook


# Fetch this script and reload .bashrc
function rld() {
    curl -o ~/.chromeos-functions https://raw.githubusercontent.com/nathanchance/scripts/master/os/chromeos
    source ~/.bashrc
}


# Set vim runtime area
export VIMRUNTIME=/usr/local/share/vim/vim80


# Neofetch function
function neofetch() {
    echo
    /usr/local/bin/neofetch --distro_shorthand tiny "${@}"
    echo
}


# Function to upload to del.dog
function deldog() {
    RESULT=$(curl -sf --data-binary @"${1:--}" https://del.dog/documents) || {
        echo "ERROR: failed to post document" >&2
        return 1
    }
    KEY=$(jq -r .key <<< "${RESULT}")
    echo "https://del.dog/${KEY}"
    echo "https://del.dog/raw/${KEY}"
}


# Export current home for use with su
export USER_HOME=${HOME}


# adb needs to be executed as root and have HOME defined in a writable folder
function adb() {
    sudo su --preserve-environment -c "HOME=${USER_HOME} /usr/local/bin/adb ${*}"
}


# fastboot needs to be executed as root and have HOME defined in a writable folder
function fastboot() { 
    sudo su --preserve-environment -c "HOME=${USER_HOME} /usr/local/bin/adb ${*}"
}


# Update function
function upd() {
    crew update
    crew upgrade
}


# Reinstall function in case Chromebrew blows up...
function reinstall() {
    # Wipe /usr/local and reinstall emerge packages
    sudo dev_install --reinstall -y

    # Reinstall adb/fastboot
    dwnld
    rm -rf tmp
    mkdir -p tmp
    local URL
    URL=$(curl -s https://dl.google.com/android/repository/platform-tools-latest-linux.zip | cut -d \" -f 2)
    curl -s "${URL}" -o tmp.zip
    bsdtar -x -f tmp.zip
    cd platform-tools || return
    # shellcheck disable=SC2033
    sudo install adb dmtracedump e2fsdroid etc1tool fastboot hprof-conv make_f2fs mke2fs mke2fs.conf sload_f2fs sqlite3 /usr/local/bin
    sudo install lib64/libc++.so /usr/local/lib64
    dwnld
    rm -rf tmp
    mkdir -p tmp

    # Reinstall neofetch
    sudo curl -s https://raw.githubusercontent.com/dylanaraps/neofetch/master/neofetch -o /usr/local/bin/neofetch
    sudo chmod a+x /usr/local/bin/neofetch

    # Reload functions
    rld
}


# Generate new SSH key for server interaction
function gen-ssh() {
    ssh-keygen -t rsa
    ssh-copy-id nathan@94.130.39.26
}
